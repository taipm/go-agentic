name: Code Quality

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25.5
        cache: true

    - name: Install linters
      run: |
        go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

    - name: Run golangci-lint
      run: |
        cd go-agentic
        golangci-lint run --timeout=5m

    - name: Run go vet
      run: |
        cd go-agentic
        go vet ./...

    - name: Check go fmt
      run: |
        cd go-agentic
        if [ -n "$(gofmt -l .)" ]; then
          echo "Go files are not formatted:"
          gofmt -d .
          exit 1
        fi
        echo "✓ All files properly formatted"

    - name: Check for unused dependencies
      run: |
        cd go-agentic
        go mod tidy
        if [ -n "$(git diff go.mod go.sum)" ]; then
          echo "❌ ERROR: Dependencies not tidy"
          git diff
          exit 1
        fi
        echo "✓ Dependencies are tidy"

    - name: Verify module integrity
      run: |
        cd go-agentic
        go mod verify
        echo "✓ Module integrity verified"

    - name: Check for deprecated packages
      run: |
        cd go-agentic
        # Check if using deprecated standard library packages
        if grep -r "io/ioutil\|math/rand" *.go 2>/dev/null | grep -v "// ignore"; then
          echo "⚠️  Warning: Using deprecated packages"
        fi
        echo "✓ No deprecated packages detected"
