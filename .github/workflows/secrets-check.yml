name: Secrets Management & Environment Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secrets-audit:
    name: Secrets Audit & Rotation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for exposed secrets with git-secrets
        run: |
          echo "ðŸ” Installing git-secrets..."
          brew install git-secrets || apt-get install -y git-secrets
          git secrets --install
          git secrets --register-aws
          echo "ðŸ” Running git-secrets scan..."
          git secrets --scan
          echo "âœ… No exposed secrets detected"

      - name: Verify .env.example doesn't have real values
        run: |
          echo "ðŸ” Checking .env.example for real API keys..."
          if [ -f .env.example ]; then
            if grep -q "sk-" .env.example; then
              echo "âŒ ERROR: .env.example contains real API keys!"
              exit 1
            fi
            if grep -q "OPENAI_API_KEY=sk-" .env.example; then
              echo "âŒ ERROR: .env.example contains real OPENAI_API_KEY!"
              exit 1
            fi
            echo "âœ… .env.example is safe (contains placeholders only)"
          fi

      - name: Scan for leaked GitHub tokens
        run: |
          echo "ðŸ” Scanning for GitHub tokens..."
          ! grep -r "ghp_" . --include="*.go" --include="*.yaml" --include="*.yml" \
            --exclude-dir=.git --exclude-dir=vendor --exclude-dir=.github
          echo "âœ… No GitHub tokens found"

      - name: Check for database credentials
        run: |
          echo "ðŸ” Scanning for database credentials..."
          ! grep -r "password.*=" . --include="*.go" --include="*.yaml" --include="*.yml" \
            --exclude-dir=.git --exclude-dir=vendor --exclude-dir=.github | grep -v "password: " || true
          echo "âœ… Database credential check passed"

  env-structure-validation:
    name: Environment File Structure Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate .env.example structure
        run: |
          echo "ðŸ” Validating .env.example structure..."

          if [ ! -f .env.example ]; then
            echo "âš ï¸  Creating .env.example template..."
            cat > .env.example << 'EOF'
# API Configuration
OPENAI_API_KEY=sk-your-key-here

# Application Settings
APP_ENV=development
APP_PORT=8080

# Note: Never commit actual .env file with real credentials
# Copy this file to .env and fill in your actual values
EOF
            echo "âœ… .env.example created"
          fi

          # Validate format
          if ! grep -q "OPENAI_API_KEY" .env.example; then
            echo "âŒ ERROR: .env.example missing OPENAI_API_KEY"
            exit 1
          fi

          echo "âœ… .env.example structure is valid"

      - name: Check .gitignore has .env
        run: |
          echo "ðŸ” Checking .gitignore configuration..."
          if [ ! -f .gitignore ]; then
            echo "âš ï¸  Creating .gitignore..."
            cat > .gitignore << 'EOF'
# Environment files (NEVER commit these!)
.env
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# Go
bin/
dist/
vendor/
*.exe
*.dll
*.so
*.dylib
.DS_Store

# Build artifacts
coverage.out
*.test

# Logs
*.log
EOF
            echo "âœ… .gitignore created"
          fi

          if grep -q "\.env" .gitignore; then
            echo "âœ… .gitignore properly excludes .env files"
          else
            echo "âŒ WARNING: .gitignore doesn't exclude .env files!"
            echo "Adding .env to .gitignore..."
            echo "" >> .gitignore
            echo "# Environment files" >> .gitignore
            echo ".env" >> .gitignore
            echo ".env.local" >> .gitignore
          fi

  api-key-rotation-reminder:
    name: API Key Rotation Reminder
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Create rotation reminder
        run: |
          echo "ðŸ”” Reminder: Check if API keys need rotation"
          echo "Last rotation check: $(date)"
          echo ""
          echo "Action Items:"
          echo "1. Review all GitHub Secrets in repository settings"
          echo "2. Check OPENAI_API_KEY rotation policy"
          echo "3. Verify no secrets are stored in code or comments"
          echo "4. Update secrets if any developer has left the project"
