name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os: [linux, darwin, windows]
        arch: [amd64, arm64]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.25.5
        cache: true

    - name: Build library
      run: |
        cd go-agentic
        go build ./...

    - name: Run tests before release
      run: |
        cd go-agentic
        go test -v ./...

    - name: Run security checks
      run: |
        # Final security check before release
        echo "Running final security checks..."

        # Check for hardcoded secrets
        if grep -r "OPENAI_API_KEY\s*=" go-agentic/ examples/ --include="*.go" 2>/dev/null | grep -v "placeholder\|example"; then
          echo "❌ ERROR: Found hardcoded credentials"
          exit 1
        fi

        # Check .gitignore is in repo
        if [ ! -f ".gitignore" ]; then
          echo "❌ ERROR: .gitignore is missing"
          exit 1
        fi

        # Verify .env is ignored
        if ! grep -q "\.env" .gitignore; then
          echo "❌ ERROR: .env is not in .gitignore"
          exit 1
        fi

        echo "✓ All security checks passed"

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          ## go-agentic Release ${{ github.ref }}

          ### Key Features
          - Multi-agent orchestration system
          - Real-time SSE streaming
          - Intelligent agent routing
          - YAML-based configuration
          - Comprehensive testing framework
          - Production-ready error handling

          ### Dependencies
          - Go 1.25.5
          - OpenAI SDK v3.15.0
          - YAML v3.0.1

          ### Security
          ✓ All security checks passed
          ✓ No hardcoded credentials
          ✓ Dependencies verified
          ✓ Code quality verified

          See [RELEASE_v0.0.1-alpha.1.md](RELEASE_v0.0.1-alpha.1.md) for details.
        draft: false
        prerelease: true
