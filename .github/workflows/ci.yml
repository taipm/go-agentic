name: CI - Build & Test

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-checks:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

      - name: Check for hardcoded API keys
        run: |
          echo "ðŸ” Scanning for hardcoded secrets..."
          ! grep -r "sk-" . --include="*.go" --include="*.yaml" --include="*.yml" \
            --exclude-dir=.git --exclude-dir=vendor --exclude-dir=.github
          ! grep -r "OPENAI_API_KEY.*=" . --include="*.go" --include="*.yaml" --include="*.yml" \
            --exclude-dir=.git --exclude-dir=vendor --exclude-dir=.github
          echo "âœ… No hardcoded API keys found"

      - name: Check .env files
        run: |
          echo "ðŸ” Checking .env file handling..."
          if [ -f .env ]; then
            echo "âŒ ERROR: .env file should not be committed!"
            exit 1
          fi
          echo "âœ… No .env file in repository"

      - name: Check .env.example exists
        run: |
          echo "ðŸ” Verifying .env.example template exists..."
          if [ ! -f .env.example ]; then
            echo "âš ï¸  WARNING: .env.example not found (should contain example structure)"
          else
            echo "âœ… .env.example exists"
          fi

  lint:
    name: Go Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run gofmt check
        run: |
          echo "ðŸ” Checking Go code format..."
          gofmt -s -l . 2>/dev/null | grep -v vendor | grep -v '.git' || true
          if [ $(gofmt -s -l . 2>/dev/null | grep -v vendor | grep -v '.git' | wc -l) -gt 0 ]; then
            echo "âŒ Code format issues found. Run: gofmt -s -w ."
            exit 1
          fi
          echo "âœ… Code format is correct"

      - name: Run goimports check
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          echo "ðŸ” Checking import organization..."
          goimports -l . 2>/dev/null | grep -v vendor | grep -v '.git' || true
          echo "âœ… Import organization checked"

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m --disable-all -E gofmt -E govet -E ineffassign -E unused

  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: [security-checks, lint]
    strategy:
      matrix:
        go-version: ['1.20', '1.21']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build core library
        run: |
          echo "ðŸ”¨ Building core library..."
          cd core
          go build -v ./...
          echo "âœ… Core library built successfully"

      - name: Build go-crewai example
        run: |
          echo "ðŸ”¨ Building go-crewai example..."
          cd examples/go-crewai
          go build -v ./cmd/main.go
          echo "âœ… go-crewai example built successfully"

      - name: Build it-support example
        run: |
          echo "ðŸ”¨ Building it-support example..."
          cd examples/it-support
          go build -v ./cmd/main.go
          echo "âœ… it-support example built successfully"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          cd core
          go test -v -race -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out
          echo "âœ… Tests completed"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./core/coverage.out
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run nancy for dependency vulnerabilities
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
          cd core
          go list -json -m all | nancy sleuth

      - name: Check Go version compatibility
        run: |
          echo "âœ… Go version compatibility check skipped (uses go.mod)"
