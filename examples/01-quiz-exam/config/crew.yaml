version: "1.0"
name: quiz-exam-crew
description: |
  Thi vấn đáp 2 agents (đơn giản):
  - Giáo viên (Teacher): Đặt câu hỏi và chấm điểm
  - Học sinh (Student): Trả lời câu hỏi
  - Report tự động lưu sau mỗi RecordAnswer
  - Một vòng thi = 10 câu hỏi
  - Trên 5 điểm = ĐẠT
entry_point: teacher

agents:
  - teacher
  - student
  - reporter

routing:
  # ✅ PARALLEL ROUTING (Phase 3.1+): Teacher orchestrates parallel tasks
  # After each action, multiple agents process simultaneously
  signals:
    teacher:
      # When teacher emits [QUESTION], send to BOTH student AND reporter in parallel
      - signal: "[QUESTION]"
        target: ""  # ✅ Teacher can emit multiple signals - handled by parallel_targets in execution
        parallel_targets:  # Simultaneous handoffs
          - student      # Student answers the question
          - reporter     # Reporter records the question

      # After receiving answer from student, teacher processes then marks end
      - signal: "[ANSWER]"
        target: ""  # Teacher acknowledges, decides if more questions or [END_EXAM]

      # Terminate signal
      - signal: "[END_EXAM]"
        target: reporter  # Notify reporter to finalize report

    student:
      # When student answers, report goes back to teacher (ready for next iteration)
      - signal: "[ANSWER]"
        target: teacher

    reporter:
      # Reporter silently records [QUESTION] and [ANSWER] signals
      # No routing - just saves and confirms with [OK]
      - signal: "[QUESTION]"
        target: ""  # ✅ Reporter receives from parallel_targets, processes, emits [OK]

      - signal: "[ANSWER]"
        target: ""  # ✅ Reporter receives from parallel_targets, processes, emits [OK]

      - signal: "[END_EXAM]"
        target: ""  # ✅ Reporter finalizes and terminates

  agent_behaviors:
    teacher:
      wait_for_signal: true   # ✅ Wait for student's [ANSWER] before proceeding
      parallel_execution: true # Allow simultaneous handoffs to student + reporter
    student:
      wait_for_signal: true   # Wait for teacher's [QUESTION]
      parallel_execution: false
    reporter:
      wait_for_signal: true   # Listen for [QUESTION] and [ANSWER] signals
      parallel_execution: false

settings:
  max_rounds: 100     # ✅ Increased: Allow LLM to adapt to validation errors through feedback loop
  max_handoffs: 100   # ✅ Prevents infinite loop if [END_EXAM] signal fails
  config_mode: strict

  # Timeout parameters
  parallel_timeout_seconds: 60
  tool_execution_timeout_seconds: 5
  tool_result_timeout_seconds: 30
  min_tool_timeout_millis: 100
  stream_chunk_timeout_millis: 500
  sse_keep_alive_seconds: 30
  request_store_cleanup_minutes: 5
  retry_backoff_min_millis: 100
  retry_backoff_max_seconds: 5
  client_cache_ttl_minutes: 60
  graceful_shutdown_check_millis: 100

  # Size limits
  max_input_size_kb: 10
  min_agent_id_length: 1
  max_agent_id_length: 128
  max_request_body_size_kb: 100
  max_tool_output_chars: 2000
  max_total_tool_output_chars: 4000
  stream_buffer_size: 100
  max_stored_requests: 1000

  # Threshold
  timeout_warning_threshold_pct: 20

  # Cost control
  max_tokens_per_call: 4000
  max_tokens_per_day: 100000
  max_cost_per_day: 50.0
  cost_alert_threshold: 0.80

  # Memory management
  max_memory_mb: 512
  max_daily_memory_gb: 10
  memory_alert_percent: 80.0
  max_context_window: 32000
  context_trim_percent: 20.0
  slow_call_threshold_seconds: 30

  # Performance & reliability
  max_errors_per_hour: 10
  max_errors_per_day: 50
  max_consecutive_errors: 5

  # Rate limiting & quotas (STRICT MODE)
  max_calls_per_minute: 60
  max_calls_per_hour: 1000
  max_calls_per_day: 10000
  block_on_quota_exceed: true
